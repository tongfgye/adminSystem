<!DOCTYPE html>
<HTML>
<HEAD>
<TITLE>ZTREE DEMO - beforeEditName / beforeRemove / onRemove /
	beforeRename / onRename</TITLE>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<link rel="stylesheet" href="../ztree_css/demo.css" type="text/css">
<link rel="stylesheet" href="../ztree_css/zTreeStyle/zTreeStyle.css"
	type="text/css">
<!-- <link href="../assets/css/bootstrap.css" rel="stylesheet" /> -->
<script type="text/javascript" src="../ztree_js/jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="../ztree_js/jquery.ztree.core.js"></script>
<script type="text/javascript" src="../ztree_js/jquery.ztree.excheck.js"></script>
<script type="text/javascript" src="../ztree_js/jquery.ztree.exedit.js"></script>

<SCRIPT type="text/javascript">
	var setting = {
		view : {
			addHoverDom : addHoverDom,
			removeHoverDom : removeHoverDom,
			selectedMulti : false
		},
		edit : {
			enable : true,
			editNameSelectAll : true,
			showRemoveBtn : showRemoveBtn,
			showRenameBtn : showRenameBtn
		},
		data : {
			simpleData : {
				enable : true
			}
		},
		callback : {
			beforeDrag : beforeDrag,
			beforeEditName : beforeEditName,
			beforeRemove : beforeRemove,
			beforeRename : beforeRename,
			onRemove : onRemove,
			onRename : onRename,
			onClick : onClick
		}
	};

// 	var zNodes = [];
var zNodes = [ {
		id : 1,
		pId : 0,
		name : "电脑电源问题",
		open : true
	}, {
		id : 11,
		pId : 1,
		name : "电源线故障"
	}, {
		id : 12,
		pId : 1,
		name : "电风扇转动失灵"
	}, {
		id : 13,
		pId : 1,
		name : "插排不通电"
	}, {
		id : 2,
		pId : 0,
		name : "显示器问题",
		open : true
	}, {
		id : 21,
		pId : 2,
		name : "排线断了"
	}, {
		id : 22,
		pId : 2,
		name : "显示管烧毁"
	}, {
		id : 23,
		pId : 2,
		name : "显卡不识别"
	} ];
// 	$(function() {

// 		$.ajax({
// 			cache : true,
// 			type : "get",
// 			url : "http://localhost:8095/findTreeList",
// 			async : false,
// 			dataType : "json",
// 			success : function(data) {

// 				zNodes = data;
// 			},
// 			error : function(data) {
// 			}
// 		})

// 	});
	var log, className = "dark";
	function beforeDrag(treeId, treeNodes) {
		return false;
	}

	//编辑节点 
	function beforeEditName(treeId, treeNode) {
		className = (className === "dark" ? "" : "dark");
		showLog("[ " + getTime() + " beforeEditName ]&nbsp;&nbsp;&nbsp;&nbsp; "
				+ treeNode.name);
		var zTree = $.fn.zTree.getZTreeObj("treeDemo");
		zTree.selectNode(treeNode);
		setTimeout(function() {
			if (confirm("进入节点 -- " + treeNode.name + " 的编辑状态吗？")) {
				setTimeout(function() {
					zTree.editName(treeNode);

				}, 0);
			}
		}, 0);

		return false;
	}

	function editTreeNode(treeId, names) {
		$.ajax({
			data : {
				id : treeId,
				name : names
			},
			type : "post",
			url : "http://localhost:8095/editTreeNodeName",
			success : function(data) {
				if (data == "success") {
					alert("修改成功");
				}
			},
			error : function(data) {
				alert("修改失败");
			}
		});
	}
	//删除节点
	function beforeRemove(treeId, treeNode) {
		className = (className === "dark" ? "" : "dark");
		showLog("[ " + getTime() + " beforeRemove ]&nbsp;&nbsp;&nbsp;&nbsp; "
				+ treeNode.name);
		var zTree = $.fn.zTree.getZTreeObj("treeDemo");
		zTree.selectNode(treeNode);
		var isDelete = confirm("确认删除 节点 -- " + treeNode.name + " 吗？");

		if (isDelete) {
			deleteNode(treeNode.id);
		}
		return isDelete;
	}

	function deleteNode(id) {
		$.ajax({
			data : {
				id : id
			},
			type : "post",
			url : "http://localhost:8095/delete",
			success : function(data) {
				if (data == "success") {
					alert("删除成功");
				}
			},
			error : function(data) {
				alert("删除失败");
			}
		});

	}

	function onRemove(e, treeId, treeNode) {
		showLog("[ " + getTime() + " onRemove ]&nbsp;&nbsp;&nbsp;&nbsp; "
				+ treeNode.name);
	}
	function beforeRename(treeId, treeNode, newName, isCancel) {
		className = (className === "dark" ? "" : "dark");
		showLog((isCancel ? "<span style='color:red'>" : "") + "[ " + getTime()
				+ " beforeRename ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name
				+ (isCancel ? "</span>" : ""));
		if (newName.length == 0) {
			setTimeout(function() {
				var zTree = $.fn.zTree.getZTreeObj("treeDemo");
				zTree.cancelEditName();
				alert("节点名称不能为空.");
			}, 0);
			return false;
		}
		editTreeNode(treeNode.id, newName);
		return true;
	}
	function onRename(e, treeId, treeNode, isCancel) {
		showLog((isCancel ? "<span style='color:red'>" : "") + "[ " + getTime()
				+ " onRename ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name
				+ (isCancel ? "</span>" : ""));
	}
	function showRemoveBtn(treeId, treeNode) {
		//return !treeNode.isFirstNode;//如果是第一个节点 ，不展示删除button
		return true;
	}
	function showRenameBtn(treeId, treeNode) {
		//return !treeNode.isLastNode;////如果是最后一个节点 ，不展示修改button
		return true;
	}
	function showLog(str) {
		if (!log)
			log = $("#log");
		log.append("<li class='"+className+"'>" + str + "</li>");
		if (log.children("li").length > 8) {
			log.get(0).removeChild(log.children("li")[0]);
		}
	}
	function getTime() {
		var now = new Date(), h = now.getHours(), m = now.getMinutes(), s = now
				.getSeconds(), ms = now.getMilliseconds();
		return (h + ":" + m + ":" + s + " " + ms);
	}

	var newCount = 1;
	function addHoverDom(treeId, treeNode) {
		var sObj = $("#" + treeNode.tId + "_span");
		if (treeNode.editNameFlag || $("#addBtn_" + treeNode.tId).length > 0)
			return;
		var addStr = "<span class='button add' id='addBtn_" + treeNode.tId
				+ "' title='add node' onfocus='this.blur();'></span>";
		sObj.after(addStr);
		var btn = $("#addBtn_" + treeNode.tId);
		if (btn)
			btn.bind("click", function() {
				$.ajax({
					type : "GET",
					url : "http://localhost:8095/getZtreeId",
					success : function(data) {
						newCount = data;
						var zTree = $.fn.zTree.getZTreeObj("treeDemo");
						var id = newCount + 1;
						var pId = treeNode.id;
						var name = "new node" + (newCount++);
						zTree.addNodes(treeNode, {
							id : id,
							pId : pId,
							name : name

						});
						savaTree(id, pId, name);
					},
					error : function(data) {
					}
				});

				return false;
			});
	};
	function removeHoverDom(treeId, treeNode) {
		$("#addBtn_" + treeNode.tId).unbind().remove();
	};
	function selectAll() {
		var zTree = $.fn.zTree.getZTreeObj("treeDemo");
		zTree.setting.edit.editNameSelectAll = $("#selectAll").attr("checked");
	}

	function getId() {
		$.ajax({
			type : "GET",
			url : "http://localhost:8095/getZtreeId",
			success : function(data) {
				newCount = data;
			},
			error : function(data) {
			}
		});

	}

	//保存 数型结构
	function savaTree(id, pId, name) {
		$.ajax({
			data : {
				id : id,
				pId : pId,
				name : name
			},
			type : "post",
			url : "http://localhost:8095/savaztree",

			success : function(data) {

				zNodes = data;
			},
			error : function(data) {
			}
		});

	}

	$(document).ready(function() {
		$.fn.zTree.init($("#treeDemo"), setting, zNodes);
		$("#selectAll").bind("click", selectAll);
	});

	//点击树节点事件
	function onClick(e, treeId, treeNode) {
		var zTree = $.fn.zTree.getZTreeObj("treeDemo");
		var nodes = zTree.getSelectedNodes();
		if (!treeNode.children) {
			/* alert(treeNode.id); */
			var id = treeNode.id;
			$.ajax({
				type : "GET",
				url : "http://localhost:8095/findByIdWtts",
				data : {
					id : id
				},
				success : function(data) {
					console.log(data);
					// 					alert(data);
					$("#id").val(data.id);
					$("#pId").val(data.pId);
					$("#name").val(data.name);
					$("#zbbh").val(data.zbbh);
					// $("#csrw").val(data.csrw);
					CKEDITOR.instances.csrw.setData(data.csrw);
					///$("#pv").val(pv);

				},
				error : function(data) {
				}
			});
		} else {
			zTree.expandNode(treeNode);
		}
	}

	//保存表单数据
	function updateForm() {
		var id = $("#id").val();
		var pId = $("#pId").val();
		var name = $("#name").val();
		var open = "";
		var zbbh = $("#zbbh").val();
		var csrw = CKEDITOR.instances.csrw.getData();///$("#csrw").val();
		var createTime = "";
		var state = "";
		var reState = "";
		var pv = "";

		$.ajax({
			type : "POST",
			url : "/wttsSave",
			data : {
				"id" : id,
				pId : pId,
				name : name,
				zbbh : zbbh,
				csrw : csrw
			},

			success : function() {
			},
			error : function(data) {
				alert(data);
			}
		});
		alert("数据保存成功");
	}
	//ajax提交form表单
	// 	$("#saveOrUpdate").SubmitForm({
	// 		url : "/qqqq/ww",
	// 		dataType : "text",
	// 		callback : function(data) {
	// 		},
	// 		before : function() {

	// 		}
	// 	}).submit();
</SCRIPT>
<!-- <script src="../thirdPart/bootstrap.min.js"></script>
	 <script src="../assets/js/bootstrap.js"></script>
 <link href="../assets/css/bootstrap.css" rel="stylesheet" /> 
    <link href="../assets/css/font-awesome.css" rel="stylesheet" />
    <link href="../assets/css/basic.css" rel="stylesheet" /> -->
<script type="text/javascript" src="../ckeditor/ckeditor.js"></script>

<script type="text/javascript">
	//替换指定name的textarea为富文本编辑器
	CKEDITOR.replace('csrw')
</script>

<style type="text/css">
.ztree li span.button.add {
	margin-left: 2px;
	margin-right: -1px;
	background-position: -144px 0;
	vertical-align: top;
	*vertical-align: middle
}
</style>
</HEAD>

<BODY>

	<!-- 	<h1>规则库维护</h1> -->
	<div class="content_wrap" style="width: 45%">
		<div class="left" id="menuContent">
			<input type="text" id="citySel" placeholder="请输入要搜索的关键字"
				onkeyup="autoMatch(this)">
			<!-- 			<div class="col-md-4"> -->
			<!-- 				<form id="uploadForm" enctype="multipart/form-data"> -->
			<!-- 					<span> -->
			<!-- 						<div class="fileupload fileupload-new" data-provides="fileupload" -->
			<!-- 							style="margin-bottom: 0px; line-height: 0px;"> -->

			<!-- 							<div class="col-md-2"> -->
			<!-- 								<span class="btn btn-file btn-default"> <span -->
			<!-- 									class="fileupload-new">导入</span> <span -->
			<!-- 									class="fileupload-exists">导入</span> <input id="file" -->
			<!-- 									type="file" name="file"> -->
			<!-- 								</span> -->
			<!-- 							</div> -->
			<!-- 							<div class="col-md-2"> -->
			<!-- 								<button id="upload" type="button" -->
			<!-- 									class="btn btn-file btn-default" style="margin-bottom: 10px;">上传</button> -->
			<!-- 							</div> -->
			<!-- 							<span class="fileupload-preview"></span>
<!-- 									<a href="#" class="close fileupload-exists" data-dismiss="fileupload" style="float: none">×</a>-->

			<!-- 						</div> -->
			<!-- 					</span> -->
			<!-- 				</form> -->
			<!-- 			</div> -->
			<ul id="treeDemo" class="ztree"></ul>
		</div>

		<div class="right">
			<div class="modal fade" id="myModal" tabindex="-1" role="dialog"
				aria-labelledby="myModalLabel" aria-hidden="true">
				<div class="modal-dialog" style="width: 900px;">
					<div class="modal-content" style="top: 50px";>
						<div class="modal-header" style="background-color: #8e8eb1";>
							<!-- 							<button type="button" class="close" data-dismiss="modal" -->
							<!-- 								aria-hidden="true">×</button> -->
							<h4 class="modal-title" id="myModalLabel">内容维护</h4>
						</div>
						<div class="modal-body">
							<form id="saveOrUpdate">
								<input class="form-control" name="id" id="id" type="hidden" />
								<input class="form-control" name="pId" id="pId" type="hidden" />
								<div class="form-group has-success">
									<label class="control-label" for="success">装备编号：</label> <input
										type="text" class="form-control" name="zbbh" id="zbbh" />
								</div>

								<div class="form-group has-success">
									<label class="control-label" for="success">调试步骤：</label> <input
										type="text" class="form-control" name="name" id="name" />
								</div>

								<!--加入ckdeitor类使其为富文本编辑器-->
								<div class="form-group has-success">
									<label class="control-label" for="success">调试详情：</label>
									<textarea class="ckeditor" name="csrw" id="csrw"></textarea>
								</div>
						</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary"
							onclick="updateForm()">保存</button>
					</div>
				</div>
				<!-- /.modal-content -->
			</div>
		</div>
	</div>
	</div>

	<script type="text/javascript">
        var system_export_path="http://localhost:8095/";
	
		function autoMatch(txtobj) {
			if (txtobj.value.length > 0) {
				InitialZtree();
				var zTree = $.fn.zTree.getZTreeObj("treeDemo");
				var nodeList = zTree.getNodesByParamFuzzy("name", txtobj.value);
				$.fn.zTree.init($("#treeDemo"), setting, nodeList);
				showMenu();
			} else {
				InitialZtree();
			}
		}

		function showMenu() {
			varcityObj = $("#citySel");
			var cityOffset = $("#citySel").offset();
			$("#menuContent").slideDown("fast");
		}

		function hideMenu() {
			$("#menuContent").fadeOut("fast");
		}

		function InitialZtree() {
			$.fn.zTree.init($("#treeDemo"), setting, zNodes);
		}

		function initEvent() {
			$("citySel").css("background-color", "#FFFFCC");
			showMenu();
		}

		$(function() {
			$("#upload").click(function () {
					
					//判断文件上传类型
					var fileSize = 0;
					//文件类型
					var filetypes = [".xls"];
					var filepath = document.getElementById("file").value;
					if(filepath == null || filepath==""){
						alert("请选择要上传excel格式的文件");
						return false;
					}
					var isnext = false;
					var fileend = filepath.substring(filepath.lastIndexOf("."));
					if (filetypes && filetypes.length > 0) {
						for (var i = 0; i < filetypes.length; i++) {
							if (filetypes[i] == fileend) {
								isnext = true;
								break;
							}
						}
					}
					if (!isnext) {
						alert('不接受此文件类型,请上传excel格式的文件！\r\n');
						return false;
					}

					//判断上传文件的大小
					fileSize = document.getElementById("file").files[0].size;
					var size = fileSize / 1024;
					var filemaxsize = 1024 * 2;//2M
					if (size > filemaxsize) {
						alert('附件大小不能大于' + filemaxsize / 1024 +'M！\r\n', );
						return false;
					}

					else {
					   var formData = new FormData($('#uploadForm')[0]);
									$.ajax({
										type: 'post',
										url: system_export_path+"/uploadWtts",
										data: formData,
										cache: false,
										processData: false,
										contentType: false,
									}).success(function (data) {
										
										if (data.code == "1") {

											alert(data.successCount + "\n"
													+ data.failCount + "\n"
													+ data.message);
										} else {
											alert("上传失败");
										}

										
									}).error(function () {
										alert("上传失败");
									});
					}
			})
		});
	</script>
</BODY>
</HTML>